<!DOCTYPE html>
<!-- 
    Next version of the Sept 21 2022 version.
    
    It has everything that the previous version has; Additionally - another code (Instructions.html here or instructions/index.html on server)
    is written that would show instructions. The code in Ax7n24 folder (Here that Ax7n24 is a subejct specific string), will direct to the instructions code (Instead
    of hid_expts.html like it was earlier doing). The instuctions are shown, and then the instructions code diretcs to this hid_expts.html code.
    This is done to implement that the experiment opens in a different tab after the instructions so that the subject can always see the instructions
    whenever they want throughout the experiment.

    Further, the 'z' fucntionality is removed (That is now by pressing 'z', you cannot directly jump to the end screen of the experiment.)

    The experiment now presents all 60 trials with gamble types randomly presented.
-->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CClab Experiment</title>
    <script src="jsregression.js"></script>

    <!-- <script src="../dist/jspsych.js"></script>
    <script src="../dist/plugin-instructions.js"></script>
    <link rel="stylesheet" href="../dist/jspsych.css"> -->

</head>


<body id="expbody">
    <style>
        .center1 {
            display: block;
            margin-left: 60%;

            margin-top: 7%;
            /*width: 50%;*/
        }

        .text1 {
            margin-left: 74%;
            /* bottom: 30px; */
        }

        .text2_in_img {
            margin-left: 20%;
            position: relative;
            margin-top: -3.5%;
            /*bottom: /*145px;*/
            /*left: /*135px;*/
            color: red;
            font-weight: bold;
        }

        .center2 {
            display: block;
            margin-left: 7%;

            margin-top: 7%;
            /*width: 50%;*/
        }

        .text2 {
            /* margin-right: 20%; */
            margin-left: 21%;
            /* bottom: 30px; */
        }

        .text1_in_img { /*this is the left one*/
            margin-left: 74%;
            position: relative;/*absolute;*/
            /*bottom: /*145px;*/
            /*left: /*220px;*/
            margin-top: -3.5%;
            color: red;
            font-weight: bold;
        }

        .origattr {
            border: 0px;
            color: black;
        }

        .acknowattr {
            border: 3px solid red;
            color: red;
        }

        .Btn {
            padding: 10px 20px;
            position: relative;
            bottom: 0%;
            margin-left: 80%;
            margin-top: 10%;
        }


    </style>
    


    <!-- 
<h3><center id="ChoiceQ" style="margin-top: 10%"></center></h3>

<div style='float: left; width: 50%'>
    <img id="img1" style = 'height: 200px; width: 200 px' class="center1"></img>
    <p id='Option1' class="text1"><small></small></p>
</div> 
<div style='float: right; width: 50%'>
    <img id="img2" style = 'height: 200px; width: 200 px' class="center2"></img>
    <p id = 'Option2' class="text2"><small></small></p>
</div> -->

    <script>

        //console.log(window.location.href);
        var subid = parent.location.href;//document.getElementById("mainexp");
        subid = subid.split('/');
        subid = subid[subid.length - 3];
        console.log(subid);

        var mydata = ExpPhase();
        console.log("mydata: " + String(mydata));
        

        function ExpPhase() {

            console.log("Inside ExpPhase");

            //delete CurrState;

            //var CurrState = GetData(subid); //Checking if the subject had previously accessed the link and has completed a part of the experiment; the data from that will be retrieved if thats the case; what will be retrived in particular is the variable 'CurrState'
            
            var CurrState = GetData(subid);
            
            console.log("GOT THE CURRSTATE: ");
            console.log(CurrState);
            
            const myh3 = document.createElement('h3');

            const mycenter = document.createElement('center');
            mycenter.style.marginTop = "10%";
            mycenter.setAttribute("id", "ChoiceQ");

            expbody.append(myh3);
            myh3.append(mycenter);

            const mydiv1 = document.createElement('div');
            mydiv1.style.float = "left";
            mydiv1.style.width = "50%";

            const myimg1 = document.createElement('img');
            myimg1.style.height = "200px";
            myimg1.style.width = "200px";
            myimg1.setAttribute("id", "img1");
            myimg1.setAttribute("class", "center1");

            myimg1.addEventListener("click",ClickLeftToKeypressEvent)
            myimg1.addEventListener("dblclick",DblClickLeftToKeypressEvent)

            const mypara1_in_img = document.createElement('p');
            mypara1_in_img.setAttribute("id", "Option1_in_img");
            mypara1_in_img.setAttribute("class", "text1_in_img");
            mypara1_in_img.style.color="red";

            const mypara1 = document.createElement('p');
            mypara1.setAttribute("id", "Option1");
            mypara1.setAttribute("class", "text1");
            //mypara1.setAttribute("class", "text1_in_img");

            const mysmall1 = document.createElement("small");

            mypara1.append(mysmall1);
            mydiv1.append(myimg1);
            mydiv1.append(mypara1_in_img);
            mydiv1.append(mypara1);
            expbody.append(mydiv1);

            const mydiv2 = document.createElement('div');
            mydiv2.style.float = "right";
            mydiv2.style.width = "50%";

            const myimg2 = document.createElement('img');
            myimg2.style.height = "200px";
            myimg2.style.width = "200px";
            myimg2.setAttribute("id", "img2");
            myimg2.setAttribute("class", "center2");

            myimg2.addEventListener("click",ClickRightToKeypressEvent)
            myimg2.addEventListener("dblclick",DblClickRightToKeypressEvent)

            const mypara2_in_img = document.createElement('p');
            mypara2_in_img.setAttribute("id", "Option2_in_img");
            mypara2_in_img.setAttribute("class", "text2_in_img");
            mypara2_in_img.style.color="red";

            const mypara2 = document.createElement('p');
            mypara2.setAttribute("id", "Option2");
            mypara2.setAttribute("class", "text2");
            //mypara2.setAttribute("class", "text2_in_img");


            const mysmall2 = document.createElement("small");

            mypara2.append(mysmall2);
            mydiv2.append(myimg2);
            mydiv2.append(mypara2_in_img)
            mydiv2.append(mypara2);
            expbody.append(mydiv2);

            const mynextarrowbutton = document.createElement('button'); //If someone does this task on phone, they will not be able to press spacebar to go to next trial, and hence adding this next arrow which they can click on to move to next trial
            mynextarrowbutton.style.marginTop = '10%';
            mynextarrowbutton.style.marginLeft = '80%';
            mynextarrowbutton.style.color = "red";
            mynextarrowbutton.style.padding = "10px 20px";
            mynextarrowbutton.setAttribute("id","mynextarrowbutton");

            mynextarrowbutton.addEventListener("click",NextTrialButton)

            expbody.append(mynextarrowbutton);

            console.log(expbody.children);

            // //Preloading the images onto the browser
            // var myimages = new Array("img/Gamble1.bmp", "img/Gamble2.bmp", "img/Gamble3.bmp", "img/Gamble4.bmp", "img/Gamble5.bmp");
            // var tempImage = [];
            // for (var imgi = 0; imgi < myimages.length; imgi++) {
            //    tempImage[imgi] = new Image();
            //    tempImage[imgi].src = myimages[imgi];
            //}



            //const GambOutPossibleValues = [[1.2, 0, 4], [0.8, 0, 5], [2.8, 0, 2.8], [3.2, 0, 2.4], [3, 0, 0.6]]; //This line of code is Sensitive to number and value of outcomes of the gambles - that is, it will need to be changed if the number and value of gamble outcomes changes
            const GambOutPossibleValues = [[15, -20, 50], [10, -10, 64], [38, -7, 38], [40, -10, 30], [38, -2, 8]];
            const GambExpecVals = [11.5,16.8,15.5,23,14.5] //Took these from 'RiskTypes_Design.xlx' in CHOICE_vs_EVAL folder
            var InitCEGambleSeq = CurrState.InitCEGambleSeqC;
            var ImproveLogitGambleSeq = CurrState.ImproveLogitGambleSeqC;
            var GambleSeq = InitCEGambleSeq;
            //saveData(String(InitCEGambleSeq)+"\n");


            var ind = CurrState.indC;
            var someselect = 0; //To keep track of whether some option is selected or not
            var whichselect = 0; //To keep track of which of the two arrow keys is selected.
            var legitselect = 0; //To make sure that the left/right arrow keys pressed only during choice phase are cosnidered; If someone presses Enter or left/right arrow suirng say outcome phase, this flag makes sure that, that does not get recorded as a choice.
            var AtFeedback = 0; //To keep track of whether the screen is showing feedback or something else
            var secondhalfbegun = CurrState.secondhalfbegunC;//0; //To keep track of whether the second half of experiment (where the ST value around initialCE estimate are presented) is going on or whether the first half is going on. 0 means first half is going on.
            var Gambind = GambleSeq[ind];
            var GambLeftRight = [1, 2];

            var GambHigh = CurrState.GambHighC;
            var GambLow = CurrState.GambLowC;

            var CurrCE = [];
            var STval = 0; //(i,j) --> ith gamble, i goes from 1 to 5; jth ST val that was presented, j goes from 1 to 30
            var STvalSoFar = CurrState.STvalSoFarC; //Keeping track of what ST value was presented alongside what gamble; each row corresponds to a gamble //Sensitive to number of gambles
            var ChoiceSoFar = CurrState.ChoiceSoFarC; //Keeping track of what choice was made for every gamble's trial; each row corresponds to the gamble //Sensitive to number of gambles
            var STvalLow = CurrState.STvalLowC; //One value each for 5 gambles
            var STvalHigh = CurrState.STvalHighC; //One value each for 5 gambles


            var prevChoice = CurrState.prevChoiceC; //What was selected in previous presentation of the gamble i. 1: Gamble selected; 0: ST selected
            var STHighLow = CurrState.STHighLowC;
            //var store_choices = [[]];
            var output = 0;

            var trialdata = {
                subjC: subid,
                CurrGamb: Gambind,
                Choice: prevChoice[Gambind],
                Outcome: output,
                STvalue: STval
            };



            var logistic = new jsregression.LogisticRegression({ //This is for the second half
                alpha: 0.01,
                iterations: 10000,
                lambda: 0.0
            });
            //Earlier alpha was 0.001 and iteration was 1000


            if (ind == GambleSeq.length && secondhalfbegun == 1) { //This happens when all trials in InitCEGambleSeq and ImproveLogitGambleSeq have been conducted --> end of experiment

                document.removeEventListener('keyup', acknMoveon);

                document.getElementById("img1").style.display = "none";
                document.getElementById("img2").style.display = "none";

                document.getElementById("Option1").textContent = null;
                document.getElementById("Option2").textContent = null;

                document.getElementById("ChoiceQ").style.marginTop = "25%";
                //subid = subid.fontcolor("red");
                document.getElementById("ChoiceQ").textContent = "Experiment Over. Thanks for your participation! Please screenshot this page or note down this code: " + subid;
                return;
            }


            conducttrial(Gambind);


            function sleep(x) { //x in milliseconds
                console.log('Just waiting')
                const starttime = Date.now();
                var currtime = starttime;

                while (currtime <= starttime + x) {
                    currtime = Date.now();
                }

            }

            function ClickLeftToKeypressEvent () {
                console.log("INSIDE ClickLeftToKeypressEvent FUNCTION")
                event.code = "ArrowLeft";
                acknMoveon(event.code);
            }

            function DblClickLeftToKeypressEvent () {
                console.log("INSIDE DblClickLeftToKeypressEvent FUNCTION")
                whichselect = 1;
                event.code = "Enter";
                acknMoveon(event.code, whichselect);
            }

            function ClickRightToKeypressEvent () {
                console.log("INSIDE ClickRightToKeypressEvent FUNCTION")
                event.code = "ArrowRight";
                acknMoveon(event.code);
            }

            function DblClickRightToKeypressEvent () {
                console.log("INSIDE DblClickRightToKeypressEvent FUNCTION")
                whichselect = 2;
                event.code = "Enter";
                acknMoveon(event.code, whichselect);
            }

            function NextTrialButton() {

                event.code = "Space";
                console.log("Inside NextTrialButton")
                console.log("AtFeedback:",AtFeedback)
                acknMoveon(event.code);
            }

            function acknMoveon() {

                console.log(event.code)

                if (event.code === "ArrowRight") {
                    Option2.style.color = "red";
                    img2.style.border = "3px solid red";

                    Option1.style.color = "black";
                    img1.style.border = "0px";

                    //someselect = 1;
                    whichselect = 2;

                }

                else if (event.code === "ArrowLeft") {
                    Option1.style.color = "red";
                    img1.style.border = "3px solid red";


                    Option2.style.color = "black";
                    img2.style.border = "0px";

                    //someselect = 1;
                    whichselect = 1;
                }

                if (whichselect != 0 && event.code === "Enter" && legitselect == 1) {
                    UpdateValues();
                    showoutput(whichselect, Gambind, GambLeftRight);

                    trialdata.CurrGamb = Gambind;
                    trialdata.Choice = prevChoice[Gambind];
                    trialdata.Outcome = output;
                    trialdata.STvalue = STval;

                    STvalSoFar[Gambind].push(STval);
                    console.log("STvalSoFar: " + STvalSoFar);
                    ChoiceSoFar[Gambind].push(prevChoice[Gambind]);
                    console.log("ChoiceSoFar: " + ChoiceSoFar);

                    console.log("trialdata: " + JSON.stringify(trialdata));
                    saveData(JSON.stringify(trialdata) + "\n");
                    //saveData(trialdata);
                    //sleep(2000);

                    //someselect = 0;
                    whichselect = 0;
                    legitselect = 0; // To make sure that people cannot accidently make a selection at other times when the options are not on screen (Say when output is being shown)

                    //store_choices[ind] = prevChoice;


                    ind = ind + 1;
                    console.log("ind: " + ind);


                    CurrState.secondhalfbegunC = secondhalfbegun;
                    CurrState.STvalSoFarC = STvalSoFar;
                    CurrState.ChoiceSoFarC = ChoiceSoFar;
                    CurrState.STvalLowC = STvalLow;
                    CurrState.STvalHighC = STvalHigh;
                    //CurrState.prevChoice = prevChoice;
                    CurrState.STHighLowC = STHighLow;
                    CurrState.indC = ind;
                    CurrState.GambHighC = GambHigh;
                    CurrState.GambLowC = GambLow;

                    var Logit_model_temp = findLogitModel();
                    CurrState.GambLogitParam[Gambind] = Logit_model_temp;

                    CurrState.TotEarnedReward = Number(CurrState.TotEarnedReward) + Number(output)

                    var ValOfBetterOption = (STval>=Number(GambExpecVals[Gambind])) ? STval : Number(GambExpecVals[Gambind])

                    CurrState.TotPossibleReward = Number(CurrState.TotPossibleReward) + Number(ValOfBetterOption)

                    if (ind == GambleSeq.length && secondhalfbegun == 0) {
                        GambleSeq = ImproveLogitGambleSeq;
                        secondhalfbegun = 1;
                        //CalcLogisticModel();
                        ind = 0;
                        Gambind = GambleSeq[ind];

                    }

                    else if (ind == GambleSeq.length && secondhalfbegun == 1) { //This happens when all trials in InitCEGambleSeq and ImproveLogitGambleSeq have been conducted --> end of experiment
                        var Logit_model = findLogitModel();
                        Logit_model.subjC = subid;
                        console.log(JSON.stringify(Logit_model));
                        saveData(JSON.stringify(Logit_model) + "\n"); //Storing the Logit model based on all the choice data

                        CurrState.secondhalfbegunC = secondhalfbegun;
                        CurrState.STvalSoFarC = STvalSoFar;
                        CurrState.ChoiceSoFarC = ChoiceSoFar;
                        CurrState.STvalLowC = STvalLow;
                        CurrState.STvalHighC = STvalHigh;
                        CurrState.prevChoiceC = prevChoice;
                        CurrState.STHighLowC = STHighLow;
                        CurrState.indC = ind;
                        CurrState.GambHighC = GambHigh;
                        CurrState.GambLowC = GambLow;

                        saveData(JSON.stringify(CurrState) + "\n");

                        document.removeEventListener('keyup', acknMoveon);

                        document.getElementById("img1").style.display = "none";
                        document.getElementById("img2").style.display = "none";

                        document.getElementById("Option1").textContent = null;
                        document.getElementById("Option2").textContent = null;

                        document.getElementById('mynextarrowbutton').style.display = "none";

                        document.getElementById("ChoiceQ").style.marginTop = "25%";
                        //subid = subid.fontcolor("red");
                        document.getElementById("ChoiceQ").textContent = "Experiment Over. Thanks for your participation!"
                    }



                    Gambind = GambleSeq[ind];
                    console.log("Gambind: " + Gambind);


                    //conducttrial(Gambind);

                }

                if (event.code === "Space" && AtFeedback == 1) {

                    AtFeedback = 0;
                    Option1.style.color = "black";
                    img1.style.border = "0px";
                    Option2.style.color = "black";
                    img2.style.border = "0px";

                    conducttrial(Gambind);

                }



                if (event.code === "KeyZ") {
                    document.getElementById("img1").style.display = "none";
                    document.getElementById("img2").style.display = "none";

                    document.getElementById("Option1").textContent = null;
                    document.getElementById("Option2").textContent = null;

                    document.getElementById("ChoiceQ").style.marginTop = "25%";
                    //subid = subid.fontcolor("red");
                    document.getElementById('mynextarrowbutton').style.display = "none";

                    document.getElementById("ChoiceQ").textContent = "Experiment Over. Thanks for your participation! Please screenshot this page or note down this code: " + subid;
                }


            }

            function conducttrial(Gambind) {

                console.log("prevChoice:" + prevChoice);

                legitselect = 1; //This is to make sure that the selection can be made only after this function is called.

                //document.addEventListener('keyup',acknMoveon);

                //mytextnode.replaceWith("Make your choice");
                
                document.getElementById('mynextarrowbutton').style.display = "none";

                document.getElementById("ChoiceQ").style.marginTop = "10%";
                document.getElementById("ChoiceQ").textContent = "Make your choice";

                GambLeftRight = Math.random() > 0.5 ? [1, 2] : [2, 1];
                var GambOptiontextID = "Option" + GambLeftRight[0];
                var GambOptiontextinimgID = "Option" + GambLeftRight[0] + "_in_img";
                // var STOptiontextID = "Option" + GambLeftRight[1];

                //document.getElementById(GambOptiontextID).textContent = GambOutPossibleValues[Gambind];//""//Commented Nov 10 2023
                //document.getElementById(GambOptiontextID).color = "red"; //Nov 10 2023; Added; //Commented Nov 10 2023

                if (GambLeftRight[0]==1){
                    document.getElementById(GambOptiontextID).style.marginLeft = "72%";
                }
                else {
                    document.getElementById(GambOptiontextID).style.marginLeft = "20%";
                }

                
                document.getElementById(GambOptiontextinimgID).textContent = ' '
                document.getElementById(GambOptiontextinimgID).color = "white";

                // document.getElementById(STOptiontextID).textContent = "STval";

                var GambOptionimgID = "img" + GambLeftRight[0];
                var STOptionimgID = "img" + GambLeftRight[1];

                document.getElementById("img1").style.display = "initial";
                document.getElementById("img2").style.display = "initial";
                
                var STcolscheme = gettingRandomInt(1,3);
                var STpathstr = "img/SureThingImages/Surething" + STcolscheme + '.bmp'

                //document.getElementById(STOptionimgID).setAttribute("src", "img/risktypes_0_0.bmp");
                document.getElementById(STOptionimgID).setAttribute("src", STpathstr);
                
                var gambcolscheme = gettingRandomInt(1,6);
                var gambflip = Math.random() > 0.5 ? "0" : "45";

                switch (Gambind) {

                    case 0:
                        //document.getElementById(GambOptionimgID).setAttribute("src",  tempImage[0].src);
                        //document.getElementById(GambOptionimgID).setAttribute("src", "img/Gamble1.bmp");
                        //document.getElementById(GambOptionimgID).setAttribute("src", "img/risktypes_50_30_20.bmp");
                        var gambpathstr = "img/GambImagesC" + gambcolscheme + "flip" + gambflip +'/Gamble1.bmp';
                        document.getElementById(GambOptionimgID).setAttribute("src", gambpathstr);
                        break;

                    case 1:
                        //document.getElementById(GambOptionimgID).src = tempImage[1].src;
                        //document.getElementById(GambOptionimgID).setAttribute("src", "img/Gamble2.bmp");
                        //document.getElementById(GambOptionimgID).setAttribute("src", "img/risktypes_50_30_20.bmp");
                        var gambpathstr = "img/GambImagesC" + gambcolscheme + "flip" + gambflip +'/Gamble2.bmp';
                        document.getElementById(GambOptionimgID).setAttribute("src", gambpathstr);
                        break;

                    case 2:
                        //document.getElementById(GambOptionimgID).src = tempImage[2].src;
                        //document.getElementById(GambOptionimgID).setAttribute("src", "img/Gamble3.bmp");
                        //document.getElementById(GambOptionimgID).setAttribute("src", "img/risktypes_50_50.bmp");
                        var gambpathstr = "img/GambImagesC" + gambcolscheme + "flip" + gambflip +'/Gamble3.bmp';
                        document.getElementById(GambOptionimgID).setAttribute("src", gambpathstr);
                        break;

                    case 3:
                        //document.getElementById(GambOptionimgID).src = tempImage[3].src;
                        //document.getElementById(GambOptionimgID).setAttribute("src", "img/Gamble4.bmp");
                        //document.getElementById(GambOptionimgID).setAttribute("src", "img/risktypes_50_30_20.bmp");
                        var gambpathstr = "img/GambImagesC" + gambcolscheme + "flip" + gambflip +'/Gamble4.bmp';
                        document.getElementById(GambOptionimgID).setAttribute("src", gambpathstr);
                        break;

                    case 4:
                        //document.getElementById(GambOptionimgID).src = tempImage[4].src;
                        //document.getElementById(GambOptionimgID).setAttribute("src", "img/Gamble5.bmp");
                        //document.getElementById(GambOptionimgID).setAttribute("src", "img/risktypes_45_30_25.bmp");
                        var gambpathstr = "img/GambImagesC" + gambcolscheme + "flip" + gambflip +'/Gamble5.bmp';
                        document.getElementById(GambOptionimgID).setAttribute("src", gambpathstr);
                        break;
                }

                if (secondhalfbegun == 0) {
                    console.log("CurrstateBeforeFindingST: ")
                    console.log(CurrState);
                    findSTvalInitCE();
                }
                else {
                    findSTvalImproveLogit();
                }

            }

            function findSTvalInitCE() {

                console.log("Inside findSTvalInitCE - CurrstateBeforeFindingST: ")
                console.log(CurrState);

                console.log("STvalHigh Before: "+ STvalHigh);
                console.log("STvalLow Before: "+ STvalLow);

                var STOptiontextID = "Option" + GambLeftRight[1];
                var STOptiontextinimgID = "Option" + GambLeftRight[1]+"_in_img";

                STval = STvalHigh[Gambind];

                if (prevChoice[Gambind] == 0 && STHighLow[Gambind] == 0) {//If previous choice was ST and previous ST presented was lower end
                    let tmp1 = STvalLow[Gambind];
                    let tmp2 = GambLow[Gambind];
                    
                    tmp3 = tmp2 + (2 / 3) * (tmp1 - tmp2);

                    STval = tmp3;
    
                }

                else if (prevChoice[Gambind] == 1 && STHighLow[Gambind] == 0) {//If previous choice was Gamble and previous ST presented was lower end
                    let tmp1 = STvalHigh[Gambind];
                    let tmp2 = STvalLow[Gambind];

                    let tmp3 = tmp2 + (2 / 3) * (tmp1 - tmp2);

                    STval = tmp3;
                }

                else if (prevChoice[Gambind] == 1 && STHighLow[Gambind] == 1) {//If previous choice was Gamble and the previous ST value presented was higher end
                    let tmp1 = GambHigh[Gambind];
                    let tmp2 = STvalHigh[Gambind];
                    
                    
                    
                    let tmp3 = tmp2 + (2 / 3) * (tmp1 - tmp2);

                    STval = tmp3;
                }

                else if (prevChoice[Gambind] == 0 && STHighLow[Gambind] == 1) {//If previous choice was ST and the previous ST value presented was higher end

                    let tmp3 = STvalLow[Gambind];

                    STval = tmp3;

                }

                console.log(STval)
                STval = STval.toFixed(2);
                //document.getElementById(STOptiontextID).textContent = STval;//Commented Nov 10 2023
                //document.getElementById(STOptiontextID).color = "red"; //Nov 10 2023; Added //Commented Nov 10 2023
                //document.getElementById(STOptiontextID).color = "red";
                document.getElementById(STOptiontextinimgID).textContent = STval;
                document.getElementById(STOptiontextinimgID).color = "red";

                console.log("STvalHigh after: "+STvalHigh);
                console.log("STvalLow after: "+STvalLow);

                console.log("Inside findSTvalInitCE at the end - CurrstateAfterFindingST: ");
                console.log(CurrState);
            }


            function UpdateValues(){ 

                if (prevChoice[Gambind] == 0 && STHighLow[Gambind] == 0) {//If previous choice was ST and previous ST presented was lower end
                    
                    GambHigh[Gambind] = STvalLow[Gambind];
                    
                    STvalLow[Gambind] = GambLow[Gambind] + (1 / 3) * (GambHigh[Gambind] - GambLow[Gambind]);
                    STvalHigh[Gambind] = GambLow[Gambind] + (2 / 3) * (GambHigh[Gambind] - GambLow[Gambind]);

                    STHighLow[Gambind] = 1;
                }

                else if (prevChoice[Gambind] == 1 && STHighLow[Gambind] == 0) {//If previous choice was Gamble and previous ST presented was lower end
                    GambHigh[Gambind] = STvalHigh[Gambind];
                    GambLow[Gambind] = STvalLow[Gambind];

                    STvalLow[Gambind] = GambLow[Gambind] + (1 / 3) * (GambHigh[Gambind] - GambLow[Gambind]);
                    STvalHigh[Gambind] = GambLow[Gambind] + (2 / 3) * (GambHigh[Gambind] - GambLow[Gambind]);

                    STHighLow[Gambind] = 1;
                }

                else if (prevChoice[Gambind] == 1 && STHighLow[Gambind] == 1) {//If previous choice was Gamble and the previous ST value presented was higher end
                    GambLow[Gambind] = STvalHigh[Gambind];
                    
                    STvalLow[Gambind] = GambLow[Gambind] + (1 / 3) * (GambHigh[Gambind] - GambLow[Gambind]);
                    STvalHigh[Gambind] = GambLow[Gambind] + (2 / 3) * (GambHigh[Gambind] - GambLow[Gambind]);

                    //STHighLow remains 1; because if the gamble was chosen at higher end, we dont need to go to lower end ST value because logically that should also lead to gamble being chosen
                }

                else if (prevChoice[Gambind] == 0 && STHighLow[Gambind] == 1) {//If previous choice was ST and the previous ST value presented was higher end


                    STHighLow[Gambind] = 0;
                }

            }

            function findSTvalImproveLogit() {

                var STOptiontextID = "Option" + GambLeftRight[1];
                var STOptiontextinimgID = "Option" + GambLeftRight[1]+"_in_img";

                var Logit_model = findLogitModel(); //Logit model is calculated and the estimated parameters values get stored in Logit_model.theta
                //Finding STvalue corresponding to either 0.75 or 0.25 y value (probability of selecting ST)
                var desireprob = (Math.random() > 0.5) ? 0.75 : 0.25;
                console.log("desireprob: " + desireprob);

                STval = (Math.log(desireprob / (1 - desireprob)) - Logit_model.theta[0]) / Logit_model.theta[1];

                console.log(STval)
                STval = STval.toFixed(2);
                //document.getElementById(STOptiontextID).textContent = STval;//Commented Nov 10 2023
                //document.getElementById(STOptiontextID).color = "red";
                document.getElementById(STOptiontextinimgID).textContent = STval;
                document.getElementById(STOptiontextinimgID).color = "red";

            }


            function findLogitModel() {
                //Finds logistic regression model for gamble corresponding to Gambind
                var Logit_model = [];
                var trainingData;


                // for (var i =0;i<STvalSoFar.length;i++) { //Iterates over all gambles
                //     trainingData = [];
                //     for (var j =0;i<STvalSoFar[0].length;i++) { //iterates over all ST values and all choices within a particular gamble //This assumes that number of trials presented for all gambles are same, so number of values in (that is, length of) all STvalSoFar[0], STvalSoFar[1],...,and STvalSoFar[5] will be same, and 
                //         trainingData[j][0] = STvalSoFar[i][j];
                //         trainingData[j][1] = ChoiceSoFar[i][j];
                //     }
                //     Logit_model[i] = logistic.fit(trainingDataX,trainingDataY);

                // }


                var trainingData = Array.from(Array(STvalSoFar[Gambind].length), () => new Array(2));

                for (var j = 0; j < STvalSoFar[Gambind].length; j++) { //iterates over ST values presented and choices made for the gamble corresponding to 'Gambind' 
                    trainingData[j][0] = STvalSoFar[Gambind][j];
                    trainingData[j][1] = 1-ChoiceSoFar[Gambind][j]; //So here, in the trainingData, '1' corresponds to ST and and '0' corresponds to gamble
                }

                console.log(trainingData);

                Logit_model = logistic.fit(trainingData); //Model corresponds to the logistic regression model based on current data for the gamble corresponding to 'Gambind'
            
                return Logit_model

            }



            function showoutput(whichselect, Gambind, GambLeftRight) {

                //document.removeEventListener('keyup',acknMoveon);

                //mytextnode.replaceWith("OUTPUT");

                AtFeedback = 1;

                if (GambLeftRight[0] == whichselect) { //Gamble was selected
                    var randGamb = Math.random();

                    switch(Gambind) {

                        case 0://Gamble 1
                            if (randGamb > 0.5) {indtemp = 0;}
                            else if (randGamb <= 0.5 && randGamb > 0.2) {indtemp = 1;}
                            else {indtemp = 2;}
                        case 1://Gamble 2
                            if (randGamb > 0.4) {indtemp = 0;}
                            else if (randGamb <= 0.4 && randGamb > 0.2) {indtemp = 1;}
                            else {indtemp = 2;}

                        case 2://Gamble 3
                            if (randGamb > 0.5) {indtemp = 0;}
                            else if (randGamb <= 0.5) {indtemp = 2;}
                            else {indtemp = 1;}

                        case 3: //Gamble 4
                            if (randGamb > 0.5) {indtemp = 0;}
                            else if (randGamb <= 0.5 && randGamb > 0.2) {indtemp = 1;}
                            else {indtemp = 2;}

                        case 4: //Gamble 5
                            if (randGamb > 0.7) {indtemp = 0;}
                            else if (randGamb <= 0.7 && randGamb > 0.45) {indtemp = 1;}
                            else {indtemp = 2;}
                    }
                    output = GambOutPossibleValues[Gambind][indtemp];
                    prevChoice[Gambind] = 1;
                }
                else if (GambLeftRight[1] == whichselect) {//Surething was selected
                    output = STval;
                    prevChoice[Gambind] = 0;
                }

                CurrState.prevChoiceC = prevChoice;


                //console.log(output);

                //document.getElementById("img1").setAttribute("src",null);
                //document.getElementById("img2").setAttribute("src",null);

                document.getElementById("img1").style.display = "none";
                document.getElementById("img2").style.display = "none";

                document.getElementById("Option1").textContent = null;
                document.getElementById("Option2").textContent = null;
                document.getElementById("Option1_in_img").textContent = null;
                document.getElementById("Option2_in_img").textContent = null;

                document.getElementById("ChoiceQ").style.marginTop = "25%";
                document.getElementById("ChoiceQ").textContent = "You recieved " + output + " points!";
                //console.log(document.getElementById("ChoiceQ").textContent)

                //Button to move to next trial; Subjects can alternatively press spacebar
                document.getElementById('mynextarrowbutton').style.display = "initial";
                //document.getElementById('mynextarrowbutton').textContent = "-->";
                document.getElementById('mynextarrowbutton').innerHTML="<span>&#8594;</span>";
            }

            function StoreCurrState(event) {
                /***var numGamb = STvalSoFar.length;
                var Gambindcurr = Gambind
                var Logit_model_exit
                for (var i =0;i<numGamb;i++) { //Iterates over all gambles
                    Gambind = i;
                    Logit_model_exit = findLogitModel()
                    CurrState.GambLogitParam[Gambind] = [Logit_model_exit.theta[0],Logit_model_exit.theta[1]];
                }
                Gambind = Gambindcurr;***/

                saveData(JSON.stringify(CurrState) + "\n");
                //saveData(CurrState,2);

            }

            document.addEventListener('keyup', acknMoveon);
            //document.addEventListener('beforeunload', StoreCurrState);

            // window.addEventListener("beforeunload", function (event) {
            //     event.returnValue = "Come back soon";
            // });
            window.addEventListener("beforeunload", StoreCurrState);//PP when I write 'StoreCurrState()' or 'StoreCurrState(event)' inside addEventListener, the function gets called when the instructions get over and experiment begins - it does not get called when the page is relaoded or closed --> this behavior is not what I want; when I only write 'StoreCurrState' inside that, then it does not get called when instructions end, and does get called when page is reloaded or closed --> I want this behavior, but the alert() that I have inside the function 'StoreCurrState' does not get executed in this case though.


        } //End of ExpPhase()

        function gettingRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1) + min); // Math.random returns values between 0 and 1 where 0 is inclusive but not 1; to make max inclusive here - have done (max-min+1) instead of just (max-min) in that bracket.        function saveData(data) {
            }
        
        function saveData(data) {

            var xhr = new XMLHttpRequest();

            xhr.open('POST', 'write_data.php'); //PP Commented
            //xhr.open('POST', '../write_data.php'); //PP Added


            xhr.setRequestHeader('Content-Type', 'application/json');
            //xhr.setRequestHeader('Content-Type', 'text/plain; charset=us-ascii');

            // xhr.send(JSON.stringify({ filedata: data }));
            //xhr.send({file_data: data});

            xhr.send(data);

        }


        function GetData(subid) {//Call it using subid; post subid to file first

            console.log("Inside Get data");

            var xhr = new XMLHttpRequest();

            xhr.open("POST", "retrieve_currstate.php", false); //PP Commented
            //xhr.open("POST", "../retrieve_currstate.php", false); //PP Added
            xhr.setRequestHeader('Content-Type', 'application/json');

            // xhr.send(JSON.stringify({subj: subid}));


            // xhr.onload = function () { //This is useful when 'async' is set to true in xhr.open() --> in that case whenever the request (that was running asynchronously) gets fulfilled, this function is executed
            //     // This is where you handle what to do with the response.
            //     // The actual data is found on this.responseText
            //     console.log("Printing responseText")
            //     console.log(this.responseText); 
            // };

            //var xhr2 = new XMLHttpRequest();



            //xhr.open("get", "retrieve_currstate.php", false); //The third argument here corresponds to 'async', it is by default 'true' which means that code will start executing enxt lines while the request will be procesed in background; I dont want that, I dont want the code to move forward without getting the current state info - so I have set the async to false.

            //xhr.responseType = "text";


            //xhr.setRequestHeader('Content-Type', 'text/plain; charset=us-ascii');

            // xhr.send(JSON.stringify({ filedata: data }));
            //xhr.send({file_data: data});
            //xhr.send();

            xhr.send(JSON.stringify({ subjC: subid }))

            //var headers1 = xhr.getAllResponseHeaders();
            //console.log("headers1: " + headers1);

            //var headers2 = xhr.response;
            //console.log("headers2: " + headers2);

            var header = xhr.responseText;
            console.log("header: " + header);
            console.log("header length:" + header.length);
            var chk = (header.length > 1);
            console.log("chk:" + chk);
            //if (header !== '0') {
            if (header.length > 1) {
                //header.shift();//Removes first element of the header array
                console.log("header: " + header);

                //console.log(JSON.parse(header));

                let CurrStateloc = JSON.parse(header);

                console.log("CurrStatelocIF: ");
                console.log(CurrStateloc)
                return CurrStateloc;

            }

            else {

                var InitCEGambleSeq = [0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4]; //Sensitive to number of gambles
                InitCEGambleSeq = InitCEGambleSeq.sort(() => { return 0.5 - Math.random() }); //Randomly shuffling the array
                var ImproveLogitGambleSeq = [0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4]; //Sensitive to number of gambles
                ImproveLogitGambleSeq = ImproveLogitGambleSeq.sort(() => { return 0.5 - Math.random() }); //Randomly shuffling the array


                let CurrStateloc = {
                    subjC: subid,
                    secondhalfbegunC: 0,
                    STvalSoFarC: [[], [], [], [], []],
                    ChoiceSoFarC: [[], [], [], [], []],
                    STvalLowC: [],
                    STvalHighC: [],
                    prevChoiceC: [NaN, NaN, NaN, NaN, NaN],
                    STHighLowC: [1, 1, 1, 1, 1],
                    indC: 0,
                    InitCEGambleSeqC: InitCEGambleSeq,
                    ImproveLogitGambleSeqC: ImproveLogitGambleSeq,
                    GambHighC: [50,64,38,40,38],//[4, 5, 2.8, 3.2, 3],
                    GambLowC: [-20, -10, -7, -10, -2],
                    GambLogitParam: [[], [], [], [], []],
                    TotEarnedReward: 0,
                    TotPossibleReward: 0
                }

                for (var i = 0; i <= CurrStateloc.GambHighC.length - 1; i++) {
                    CurrStateloc.STvalLowC.push(CurrStateloc.GambLowC[i] + (1 / 3 * (CurrStateloc.GambHighC[i] - CurrStateloc.GambLowC[i])));
                    CurrStateloc.STvalHighC.push(CurrStateloc.GambLowC[i] + (2 / 3 * (CurrStateloc.GambHighC[i] - CurrStateloc.GambLowC[i])));
                }
                console.log("CurrStatelocInELSE: ");
                console.log(CurrStateloc);
                return CurrStateloc;

            }

            //return CurrStateloc;


        }



    </script>


</body>

</html>